<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>   
     <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Datastory.ch</title>
</head>
<style>
 
body {
	/*font: 10px 'Gentium Book Basic', sans-serif;*/
	font: 16pt Helvetica, sans-serif;
	background-color: #000;
	padding:0;
}
 
svg {
	//border: 1px solid white;
}
 
/*
svg * {
	fill: #be64ac;
}
*/

/* //Adobe CC CS04 scheme
#F6F88C
#333746
#74C4D4
#D9EDE2
#ED2A45
*/

button {
	color: #333;
	//color: white;
	//border: 1px solid cyan;
	border: 1px solid #333;
	background-color: black;
	outline: none;
}

path {
	//stroke: #be64ac;
	//stroke-width: 0.25em;
	//fill: #fff;
	//stroke: #fff;
}

text {
	stroke: none !important;
	//filter:url(#dropshadow);
}

rect {
	fill: #333;
}

</style>
<body>
<svg>
<!-- filter to drop shadow on text :: very ineffective -->
<!--
<filter id="dropshadow" height="130%">
  <feGaussianBlur in="SourceAlpha" stdDeviation="3"/> 
  <feOffset dx="2" dy="2" result="offsetblur"/> 
  <feMerge> 
    <feMergeNode/> 
    <feMergeNode in="SourceGraphic"/> 
  </feMerge>
</filter>
-->
</svg>
<script src="./d3.v3.min.js"></script>
<script src="./d3-jetpack.js"></script>
<script>

/*
//optimisation: d3 over webgl ? perte souplesse xml ?
*/


/***********
Controls
************/
counter = 0;
d3.select("body").insert("button","svg")
	.on("click", function() {
		display(fulldata[counter]);
		counter = (counter+1) % fulldata.length;
	})
	.text("GO");
/*
d3.select("body").insert("button","svg")
	.on("click", function() {
		groupDisplay(fulldata,counter,10,100);
		counter = (counter+10) % fulldata.length;
	})
	.text("GO 10");	
d3.select("body").insert("button","svg")
	.on("click", function() {
		groupDisplay(fulldata,counter,100,30);
		counter = (counter+100) % fulldata.length;
	})
	.text("GO 100");

d3.select("body").insert("button","svg")
	.on("click", function() {
		goImage(null);
	})
	.text("TEST IMAGE");
*/


	
/***********
Global Variables
***********/


//colors of shapes
var fillcolors = [
	//"#333746",
	"#74C4D4",
	"#93d6c3",
	"#F6F88C",
	"#ED2A45",
	"#fff"
]

/* darken 20% */
var strokecolors = [
	//"#1A1E2D",
	"#4191A1",
	"#93d6c3",
	"#C3C559",
	"#BA0012",
	"#fff"
]

// shapes
var shapes = [
	/* 0 rectangle_shape = */
	"M0,5 150,5 150,190 5,190",
	/* 1 church shape */
"M0.451,57.306L26.444,6.333l26.254,50.973v63.216h71.376l25.475,28.541v44.604H0.451V57.306L0.451,57.306z",
	/* 2 personne_shape = */
	"M0,5 150,5 150,190 5,190",
	/* 3 route = */
	"M 140.6,19.1 C 121,40.1 123.4,73 133.3,100 C 143.3,127 163.7,156 178.1,180.9 L 104.4,180.9 C 97.4,154.9 88.2,127 87.7,100 C 87.1,73 104.9,38.1 123.9,19.1 L 140.6,19.1 z M 121.8,19.1 C 102.7,38.1 82.7,73 82.1,100 C 81.5,127 88.4,154.9 95.4,180.9 L 21.9,180.9 C 21.9,152.2 26.7,127 36.6,100 C 46.5,73 80.1,34.7 104.3,19.1 L 121.8,19.1 z ",
	/* 4 rectangle_shape = */
	"M0,5 150,5 150,190 5,190"
	//FIXME !!!
]



w = 1200;
h = 800;

svg = d3.select("svg")
	.attr("width",w)
	.attr("height",h);	

/********************
Display functions
*********************/

/** Animate objects from to (starts on left- starts on right) */
function go(data_item) {
	from = {
			x:(data_item.side==0) ? jitter(200,300) : jitter(w-300,300),
		 	y:jitter(h-300,100)
		 };
	to = {x:w/2,y:0};
	
	var g = svg.append("g")
		.attr("transform","translate("+from.x+","+from.y+")")
		.style("fill",fillcolors[data_item.color])
		.style("stroke",strokecolors[data_item.color]);
	
	create(g,data_item); //TODO : create en fonction du type d'animation !!
	
	var	scale = 0.1;
	g.transition()
			.duration(8000)
			.attr("transform","scale ("+scale+") translate("+to.x/scale+","+to.y/scale+")") 
			.style("opacity","0")
			.remove(); //TODO if needed with optimization
}

/***************************************/
function goImage(data_item) {
	var img_width=1000, 
		img_height=600;
	var g = svg.append("g")
		.attr("transform","translate("+(w-img_width)/2+","+(h-img_height)/2+")")
		.append("image")
			.attr("x","0")
			.attr("y","0")
			.attr("width",img_width)
			.attr("height",img_height)
			.attr("xlink:href",data_item.url);
			//FIXME
	var random_scale = 1+(Math.random()/3)
	g.transition()
		.duration(8000)
		.attr("transform","scale ("+random_scale+")") 
		.style("opacity","0")
		.remove(); //TODO if needed with optimization
}


/** Creates a new "item" that is displayed wether right or left and attach it to the element
text is an array with multiple lines */
function create(element,d) {
	var start_text_transform = "translate("+(d.side!=0?"-30":"180")+",50)";
	var end_text_transform = "translate("+(d.side=!0?"30":"120")+",50)";
	
	//append the text
	var text_g = element
		.append("g")
		.attr("transform",start_text_transform)
	text_g.append("text")
		.attr("x",0)
		.attr("y",0)
		.style("text-anchor",d.side==0?"end":"start")
		.tspans([d.ligne1,d.ligne2,d.ligne3,d.ligne4],25); //25 = interligne
		
	var bbox = text_g.node().getBBox();
	var pad = 5;
	var bbox_g = element.insert("g",":first-child")
		.attr("transform",start_text_transform)
	bbox_g.append("rect")
		.attr("x",bbox.x-pad)
		.attr("y",bbox.y-pad)
		.attr("width",bbox.width+2*pad)
		.attr("height",bbox.height+2*pad);
	
	//append the shape
	var shape_g = element.insert("g",":first-child")
			.attr("transform","scale(0)");
	shape_g.append("path")
		.attr("d",shapes[d.shape])
	shape_g.transition()
		.duration(1000)
		.attr("transform","scale("+d.scale+")")
	//console.log(d.scale);
	
	//FIXME -> takes only the text...
	
	text_g
		.style("opacity","0")
		.transition()
		.duration(2000)
			.attr("transform",end_text_transform)
			.style("opacity","1");
	bbox_g
		.style("opacity","0")
		.transition()
		.duration(2000)
			.attr("transform",end_text_transform)
			.style("opacity","1");
}

// jitter along one dimension in the given span
function jitter(coord,span) {
	return coord + (Math.random()>0.5 ? -1 : 1) * Math.random()*span/2;
}



/**********************************************/
// Import dataset
/**********************************************/

var fulldata = [];
function loadData() {
	
	var dsv = d3.dsv(";", "text/plain");
	//dsv("test_poids_mots.csv", function(error, data) {
	//dsv("03_test_poids_mots.csv", function(error, data) {
	dsv("00_roads.csv", function(error, data) {
	//dsv("01_test-itineraires.csv", function(error, data) {
	//dsv("02_stateless.csv", function(error, data) {
	  data.forEach(function(d) {
		  //console.log(d.Scale);
		  fulldata.push({
			  ligne1:d.Ligne1,
			  ligne2:d.Ligne2,
			  ligne3:d.Ligne3,
			  ligne4:d.Ligne4,
			  shape:+d.Shape,
			  side:+d.Show_on_side,
			  color:+d.Source_dataset,
			  animation:+d.Animation_type,
			  url:d.Image_URL,
			  scale:+d.Scale
		  })
		})
		//console.log("truc");
	  });
}
loadData();







/************************************************************/
/* Main functions, randomized for tests. TODO: check jitter values */
function incCounter() {
	counter++;
}

who = 0;
function display(data_item) {
	switch(data_item.animation) {
		case 0:
			go(data_item);
			break;
			
		default:
			goImage(data_item);
			break;
	}
}
	
function groupDisplay(list,index,iterations,ms_duration) {
	display(list[index % list.length]);
	if(iterations==0) return;
	setTimeout(function() {
			groupDisplay(list,index+1,iterations-1,ms_duration);
		},
		ms_duration);
}

</script>
</body>