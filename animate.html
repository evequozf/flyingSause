<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>   
     <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Datastory.ch</title>
</head>
<style>
 
body {
	/*font: 10px 'Gentium Book Basic', sans-serif;*/
	font: 14pt Helvetica, sans-serif;
	background-color: #000;
	padding:0;
}
 
svg {
	border: 1px solid white;
}
 
/*
svg * {
	fill: #be64ac;
}
*/

/* //Adobe CC CS04 scheme
#F6F88C
#333746
#74C4D4
#D9EDE2
#ED2A45
*/

button {
	//color: black;
	color: white;
	border: 1px solid cyan;
	background-color: black;
	outline: none;
}

path {
	//stroke: #be64ac;
	//stroke-width: 0.25em;
	//fill: #fff;
	stroke: #fff;
}

text {
	stroke: none !important;
	//filter:url(#dropshadow);
}

rect {
	fill: #333;
}

</style>
<body>
<svg>
<!-- filter to drop shadow on text :: very ineffective -->
<!--
<filter id="dropshadow" height="130%">
  <feGaussianBlur in="SourceAlpha" stdDeviation="3"/> 
  <feOffset dx="2" dy="2" result="offsetblur"/> 
  <feMerge> 
    <feMergeNode/> 
    <feMergeNode in="SourceGraphic"/> 
  </feMerge>
</filter>
-->
</svg>
<script src="./d3.v3.min.js"></script>
<script src="./d3-jetpack.js"></script>
<script>

/*
//optimisation: d3 over webgl ? perte souplesse xml ?
*/


/***********
Controls
************/
counter = 0;
d3.select("body").insert("button","svg")
	.on("click", function() {
		display(fulldata[counter]);
		counter = (counter+1) % fulldata.length;
	})
	.text("GO");
d3.select("body").insert("button","svg")
	.on("click", function() {
		groupDisplay(fulldata,counter,10,100);
		counter = (counter+10) % fulldata.length;
	})
	.text("GO 10");	
d3.select("body").insert("button","svg")
	.on("click", function() {
		groupDisplay(fulldata,counter,100,30);
		counter = (counter+100) % fulldata.length;
	})
	.text("GO 100");


	
/***********
Global Variables
***********/

//TODO : fix import CSV
list = [
	["Truc","1920 Steffisburg"],
	["Machin","Huile sur toile","1986"],
	["Bidule","Rue du Clos","1211 Genève"]
]

//colors of shapes
var fillcolors = [
	"#333746",
	"#74C4D4",
	"#D9EDE2",
	"#F6F88C", //trop foncé
	"#ED2A45"
]

/* darken 20% */
var strokecolors = [
	"#1A1E2D",
	"#4191A1",
	"#A6BAAF",
	"#C3C559", //trop foncé
	"#BA0012"
]

// shapes
var shapes = [
	/* 0 rectangle_shape = */
	"M0,5 150,5 150,190 5,190",
	/* 1 church shape */
"M0.451,57.306L26.444,6.333l26.254,50.973v63.216h71.376l25.475,28.541v44.604H0.451V57.306L0.451,57.306z",
	/* 2 personne_shape = */
	"M0,5 150,5 150,190 5,190",
	/* 3 route = */
	"M0,5 150,5 150,190 5,190",
	/* 4 rectangle_shape = */
	"M0,5 150,5 150,190 5,190"
	//FIXME !!!
]



w = 1200;
h = 400;

svg = d3.select("svg")
	.attr("width",w)
	.attr("height",h);	

/********************
Display functions
*********************/

/** Animate objects from to (starts on left- starts on right) */
function go(data_item,from,to) {
	//default parameters
	(typeof colorindex === "undefined") ? 0 : colorindex;
	(typeof isOnLeft === "undefined") ? true : false;
	from = {
			x:(data_item.side==0) ? jitter(200,300) : jitter(w-300,300),
		 	y:jitter(h-300,100)
		 };
	to = {x:w/2,y:0};
	
	var g = svg.append("g")
		.attr("transform","translate("+from.x+","+from.y+")")
		.style("fill",fillcolors[data_item.color])
		.style("stroke",strokecolors[data_item.color]);
	create(g,data_item); //TODO : create en fonction du type d'animation !!
	var	scale = 0.1;
	g.transition()
			.duration(8000)
			.attr("transform","scale ("+scale+") translate("+to.x/scale+","+to.y/scale+")") 
			.style("opacity","0")
			//.remove(); //TODO if needed with optimization
}

/** Creates a new "item" that is displayed wether right or left and attach it to the element
text is an array with multiple lines */
function create(element,d) {
	var start_text_transform = "translate("+(d.side!=0?"-30":"180")+",50)";
	var end_text_transform = "translate("+(d.side=!0?"30":"120")+",50)";
	
	//append the text
	var text_g = element
		.append("g")
		.attr("transform",start_text_transform)
	text_g.append("text")
		.attr("x",0)
		.attr("y",0)
		.style("text-anchor",d.side==0?"end":"start")
		.tspans([d.ligne1,d.ligne2,d.ligne3,d.ligne4],25); //25 = interligne
		
	var bbox = text_g.node().getBBox();
	var pad = 5;
	var bbox_g = element.insert("g",":first-child")
		.attr("transform",start_text_transform)
	bbox_g.append("rect")
		.attr("x",bbox.x-pad)
		.attr("y",bbox.y-pad)
		.attr("width",bbox.width+2*pad)
		.attr("height",bbox.height+2*pad);
	
	//append the shape
	var shape_g = element.insert("g",":first-child")
			.attr("transform","scale(0)");
	shape_g.append("path")
		.attr("d",shapes[d.shape])
	shape_g.transition()
		.duration(1000)
		.attr("transform","scale("+d.scale+")")
	
	//FIXME -> takes only the text...
	
	text_g
		.style("opacity","0")
		.transition()
		.duration(2000)
			.attr("transform",end_text_transform)
			.style("opacity","1");
	bbox_g
		.style("opacity","0")
		.transition()
		.duration(2000)
			.attr("transform",end_text_transform)
			.style("opacity","1");
}

// jitter along one dimension in the given span
function jitter(coord,span) {
	return coord + (Math.random()>0.5 ? -1 : 1) * Math.random()*span/2;
}



/**********************************************/
// Import dataset
/**********************************************/

var fulldata = [];
function loadData() {
	
	var dsv = d3.dsv(";", "text/plain");
	dsv("test-eglises-2.csv", function(error, data) {
	  data.forEach(function(d) {
		  fulldata.push({
			  ligne1:d.Ligne1,
			  ligne2:d.Ligne2,
			  ligne3:d.Ligne3,
			  ligne4:d.Ligne4,
			  shape:+d.Shape,
			  side:+d.Show_on_side,
			  color:+d.Source_dataset,
			  animation:d.Animation_type,
			  url:d.Image_URL,
			  scale:d.Scale
		  })
		})
		//console.log("truc");
	  });
}
loadData();







/************************************************************/
/* Main functions, randomized for tests. TODO: check jitter values */
function incCounter() {
	counter++;
}

who = 0;
function display(data_item) {
	go(data_item/*,
			{x:(++who % 2 == 0) ? jitter(200,300) : jitter(w-300,300),
				y:jitter(h-300,100)},
			{x:w/2,y:0}/*,
			Math.round((Math.random()*fillcolors.length)), 
			(who % 2)   //left or right
			*/
		);
}
	
function groupDisplay(list,index,iterations,ms_duration) {
	display(list[index % list.length]);
	if(iterations==0) return;
	setTimeout(function() {
			groupDisplay(list,index+1,iterations-1,ms_duration);
		},
		ms_duration);
}

</script>
</body>